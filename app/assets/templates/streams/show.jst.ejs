<h3>Stream Show!</h3>
<h2><%= stream.name %> - <%= stream.status %></h2>
<object type="application/x-shockwave-flash" 
        height="378" 
        width="620" 
        id="live_embed_player_flash" 
        data="http://www.twitch.tv/widgets/live_embed_player.swf?channel=<%= stream.channel_name %>" 
        bgcolor="#000000">
  <param  name="allowFullScreen" 
          value="true" />
  <param  name="allowScriptAccess" 
          value="always" />
  <param  name="allowNetworking" 
          value="all" />
  <param  name="movie" 
          value="http://www.twitch.tv/widgets/live_embed_player.swf" />
  <param  name="flashvars" 
          value="hostname=www.twitch.tv&channel=<%= stream.channel_name %>&auto_play=true&start_volume=25" />
</object>

<h1><%= stream.name %> Chat!</h1>

<form id="message">
  
  <label>Message:
    <input type="text" name="message[text]" id="message-box">
  </label>

  <button>Send</button>
</form>

<h3>Chats</h3>
<div id="display"></div>

<script>
  var path = window.location.hash
             .substring(2)
             .split("/")
             .join("-")
             
  $("form#message").on("submit", function(event) {
    event.preventDefault();
    
    var $chatbox = $(event.currentTarget).find("input#message-box");
    var msg = $chatbox.val();
    $chatbox.val("");
    
    $.ajax({
      type: "POST",
      url: "/api/chat",
      data: {text: msg, stream: path},
      success: function(response) {}
    });
  });
  
  var pusher = new Pusher(gon.global.pusher_key);
  var channel = pusher.subscribe(path);
  channel.bind("message", function(data) {
    var $el = $('<p></p>');
    $el.text(data.user + ": " + data.message)
    $("#display").append($el);
  });
</script>